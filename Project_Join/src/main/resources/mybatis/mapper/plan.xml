<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="plan">

	<!-- PlanVo안에 있는 u_list에 값을 넣어주는 select가 바로 getPeople이며, 그것을 수행하기 위해서는 idx의 값을 전달해야 한다. 이때 받는 자료가 join.vo.UserVO다. -->		 
	<resultMap type="join.vo.PlanVO" id="planListMap">
		<id property="idx" column="idx"/>		
		<collection property="u_list" column="idx" ofType="join.vo.UserVO" select="getPeople"/>
	</resultMap>


	<!-- join.plan을 눌렀을때 게시판 리스트 나열(t_plan_req테이블 status에 1값주기) -->
	<select id="planList" resultMap="planListMap" parameterType="String">
		select a.*, (SELECT status FROM t_plan_people WHERE useridx = #{useridx} and plan_idx = a.idx) userStat
		from t_plan a
		where a.status = 1
		order by a.reg_date DESC
	</select>


	<!-- join.view(상세보기)를 클릭했을때 -->
	<select id="getView" resultMap="planListMap" parameterType="map">
		<![CDATA[select a.*, case when sysdate-1  < end_date then 'Y'
			         else 'N' end 
			        as exp_yn, (SELECT status FROM t_plan_people WHERE useridx = #{useridx} and plan_idx = a.idx) userStat 
		from t_plan a
		where a.idx = #{idx} and a.status = 1]]>
	</select>

	<!-- join.plan_write에서 plan쓰기를 저장 했을때 -->
	<insert id="write_ok" parameterType="join.vo.PlanVO">
		insert into t_plan(idx, p_pwd, title, location1, location2, tnop, content, status, writer, reg_date, start_date, end_date, latitude,longitude, file_id, plan_kind, writer_idx)
		values(#{idx}, #{p_pwd}, #{title}, #{location1}, #{location2}, #{tnop}, #{content}, #{status}, #{writer}, sysdate, #{start_date}, #{end_date}, #{latitude}, #{longitude},#{file_id}, #{plan_kind}, #{writer_idx})		
	</insert>
	
	<!--plan 신청하기를 눌렀을 때  status=0:신청상태 1:신청수락 2:신청거절 -->
	<insert id="setPoeple" parameterType="java.util.Map">
		insert into t_plan_people(idx, plan_idx, status, useridx, req_date)
		values("idx_seq".NEXTVAL, #{plan_idx}, #{status}, #{u_idx}, sysdate)
	</insert>
	
	<!-- 수정하기'버튼을 눌렀을때  -->
	<select id="editPlan" parameterType="join.vo.PlanVO" resultType="join.vo.PlanVO">
		select idx,writer_idx,
			to_char(start_date,'YYYY-MM-DD') start_date, to_char(end_date,'YYYY-MM-DD') end_date, title,
			location1, location2, content, writer, file_id, latitude, longitude, tnop, plan_kind		
		 from t_plan 
		where idx = #{idx} and writer_idx = #{writer_idx} and p_pwd = #{p_pwd}
	</select> 
	
	<!-- 수정된 게시글을 저장할때 -->
	<update id="editOK" parameterType="join.vo.PlanVO" >
		update t_plan
		set p_pwd = #{p_pwd},title = #{title}, location1 =#{location1}, location2 =#{location2}, content =#{content}, writer =#{writer}, file_id=#{file_id}, plan_kind =#{plan_kind},
					latitude = #{latitude}, longitude = #{longitude}, tnop = #{tnop}, mod_date=sysdate
		where writer_idx = #{writer_idx} and idx = #{idx}					
	</update>
	
	<!-- plan 게시물의 삭제 -->
	<update id="delete" parameterType="join.vo.PlanVO">
		update t_plan
		set status = 0
		where idx = #{idx} and writer_idx = #{writer_idx}
	</update>
	
	<!-- plan의 기본키를 가지고 Plan정보를 선별하는 select -->
	<select id="getPlan" parameterType="String" resultMap="planListMap">
		select * from t_plan
		where status = 1		
	</select>
	
	
	<!--  plan의 기본키를 가지고 참여자 정보를 선별하는 select -->
	<select id="getPeople" parameterType="String" resultType="join.vo.UserVO">
		SELECT * FROM t_user 
		WHERE id IN(SELECT useridx FROM t_plan_people WHERE plan_idx=#{idx} AND status=1)
	</select>
	
	
	
	
	<!-- ///////////////////MAIN - Recent PLAN 뽑기 //////////////////////////////// -->
	<select id="getMainPlan" resultType="HashMap">
		<![CDATA[SELECT rownum , main.* FROM (
		select title, location1, tnop, writer, to_char(start_date,'MON', 'NLS_DATE_LANGUAGE=ENGLISH') mon,
												to_char(start_date,'DD', 'NLS_DATE_LANGUAGE=ENGLISH') day
		from t_plan
		order by reg_date desc
		) main
		where rownum <= 3]]>
	</select>

</mapper>

