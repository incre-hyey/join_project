<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="user">
	<select id="getUserList" resultType="join.vo.UserVO" parameterType="hashmap">
	  select * from t_user	
	  <where> 
	 	 AND 1=1
	    <if test="id != null">
	         AND id = #{id}
	    </if> 
	    <if test="pwd != null">
	         AND pwd = #{pwd}
	    </if>
	   </where>
	</select>
	<select id="getUser" resultType="join.vo.UserVO" parameterType="hashmap">
	  select * from t_user	
	  where 1=1
	  <if test="idx != null">
	  and idx = #{idx}
	  </if>
	 </select>
	
	
	<insert id="insert" parameterType="join.vo.UserVO">
		insert into t_user (idx, id,	pwd,	name,	nickname,	phone, email,
							age,	gender,	addr1,	addr2,	blood,	file_id,	intro_content,	ip,	status,	reg_date, us_viewyn, addr3)
		values(#{idx}, #{id},	#{pwd},	#{name},	#{nickname},	#{phone} , #{email},
							#{age},	#{gender},	#{addr1},	#{addr2},	#{blood},	#{file_id}
							,	#{intro_content},	#{ip},	#{status},	#{reg_date}, #{us_viewyn}, #{addr3})
	</insert>
	<update id="updateUser" parameterType="join.vo.UserVO">
		update t_user set pwd=#{pwd} , nickname = #{nickname}, phone = #{phone},
					email = #{email}, age = #{age}, gender = #{gender}, addr1 = #{addr1},
					addr2 = #{addr2}, blood = #{blood}, file_id = #{file_id}, intro_content = #{intro_content},
					us_viewyn = #{us_viewyn} , addr3 = #{addr3}
		where idx = #{idx}
	</update>
	<update id="loginyn" parameterType="join.vo.UserVO">
		update t_user set loginyn=#{loginyn} , login_date = #{login_date}, ip = #{ip}
		where id = #{id}
	</update>
	
	
	
	
	<select id="getProfile" parameterType="map" resultMap="profileResult">
		select usr.*, (select '1' from t_like 
							where targettype = #{targettype} 
							AND userid = #{userid}
							AND targetid = usr.idx ) as likeyn
		from t_user usr
		where us_viewyn = 'Y'
		<if test='userid != ""'>
		and idx != #{userid}
		</if>
<!-- 		and usr.idx = like.userid -->
		
			<if test='type == "2"'>
				AND gender = '2'
			</if>
			<if test='type == "3"'>
				AND gender = '1'
			</if>
			<if test='type == "4"'>
<!-- 			찜목록  -->
				AND exists (  
							SELECT 1 from t_like inner
							WHERE
							targettype = 'PROFILE' 
							AND userid = #{userid}
							AND targetid = usr.idx
							)					

			</if>
		
	</select>
	
	
	<!--  -->
	<resultMap id="profileResult" type="join.vo.UserVO">
		<id property="idx" column="idx"/>
		<result property="id" column="id"/>
		<result property="name" column="content"/>
		<result property="nickname" column="content"/>
		<result property="phone" column="phone"/>
		<result property="email" column="email"/>
		<result property="age" column="age"/>
		<result property="gender" column="gender"/>
		<result property="addr1" column="addr1"/>
		<result property="addr2" column="addr2"/>
		<result property="blood" column="blood"/>
		<result property="file_id" column="file_id"/>
		<result property="intro_content" column="intro_content"/>
		<result property="status" column="status"/>
		<result property="us_viewyn" column="us_viewyn"/>
		<result property="loginyn" column="loginyn"/>
		<result property="addr3" column="addr3" />
		<result property="likeyn" column="likeyn" />
   		<collection property="likeList" ofType="join.vo.LikeVO" resultMap="likeListMap"/>
	</resultMap>
	<resultMap id="likeListMap" type="join.vo.LikeVO">
		<id property="idx" column="idx"/>
		<result property="userid" column="userid"/>
		<result property="targetid" column="targetid"/>
		<result property="targettype" column="targettype"/>
	</resultMap>
	
	
	
	
	<!--   /////////////////////MY PLAN /////////////////////////-->
	<select id="getMyPlanList" parameterType="String" resultMap="myPlanListResult">
		select idx, title, plan_kind, status,
			to_char( start_date ,'YYYY-MM-DD' ) start_date,
			to_char( end_date ,'YYYY-MM-DD' ) end_date
		from t_plan
		where writer_idx = #{userid} 
	</select>
	
	<select id="getReqList" parameterType="String" resultType="java.util.HashMap">
		select a.idx, a.status, to_char( a.req_date ,'YYYY-MM-DD HH24:MI' ) req_date, 
				to_char( a.res_date ,'YYYY-MM-DD' ) res_date,
				b.idx as useridx, b.id as userid, b.nickname, b.age, b.gender
		from t_plan_people a, t_user b
		where a.plan_idx = #{idx}
		and a.useridx = b.idx
	</select>
	
	<select id="getMyReqList" parameterType="String" resultType="java.util.HashMap">
		select a.idx, a.title, a.location1, a.status, a.writer, a.plan_kind,
			to_char( a.start_date ,'YYYY-MM-DD' ) start_date,
			to_char( a.end_date ,'YYYY-MM-DD' ) end_date,
			b.status p_status , b.idx p_idx
		from t_plan a, t_plan_people b
		where a.idx = b.plan_idx
		and b.useridx = #{userid} 
	</select>
	
	
	<resultMap type="java.util.HashMap" id="myPlanListResult">
		<id property="idx" column="idx"/>
		<result property="title" column="title"/>
		<result property="plan_kind" column="plan_kind"/>
		<result property="status" column="status"/>
		<result property="start_date" column="start_date"/>
		<result property="end_date" column="end_date"/>
		<collection property="reqUserList" column="idx" ofType="java.util.HashMap" select="getReqList">
			<id property="p_idx" column="idx"/>
			<result property="p_status" column="status" />
			<result property="p_req_date" column="req_date" />
			<result property="p_res_date" column="res_date" />
			<result property="p_userid" column="userid" />
			<result property="p_nickname" column="nickname" />
			<result property="p_age" column="age" />
			<result property="p_gender" column="gender" />
		</collection>
		
	</resultMap>
	
	<update id="updatePlanReq" parameterType="map" >
		update t_plan_people set status=#{status}
		where idx = #{idx}
	</update> 
	<delete id="deletePlanReq" parameterType="String" >
		delete from t_plan_people 
		where idx = #{idx}
	</delete>
		
</mapper>  





